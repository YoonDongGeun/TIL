# 카프카 활용 아키텍처 사례 분석

## 카카오 스마트 메시지 서비스

![image-20230508001813622](./10%EA%B0%95.assets/image-20230508001813622.png)

스마트 메시지 서비스는 소재최적화와 유저타게팅을 통해 적합한 유저에게 광고 메시지를 개인화 전송하 는 서비스이다. 사용자에게 흥미가 있는 소재를 최적화하고 적합한 유저에게 타게팅하여 광고를 선별 전송 한다.

![image-20230508001907306](./10%EA%B0%95.assets/image-20230508001907306.png)

## 스마트 메시지의 카프카 스트림즈 활용

![image-20230508002320920](./10%EA%B0%95.assets/image-20230508002320920.png)

사용자의 반응 로그(imp, click)을 취합하여 저장하고 유저 데이터를 매핑하여 처리하는 용도로 카프카 스 트림즈를 활용했다. 카프카 스트림즈의 groupByKey, windowedBy, aggregate 구문을 통해 1분 로그를 window 취합하여 적재하고 man 구문을 통해 Redis 이 유저데이터와 결합 처리하는 로직을 수행한다.

=> 2가지 타입 1. 건건히, 2. 취합

1.1개마다 저장

2. 취합은 aggregation process 필요해서 복잡도가 생김. 데이터가 너무 많을경우 건건히보다는 aggregation 필수.(DB처리량 높일 수 있다.)

### 넷플릭스 키스톤 프로젝트

![image-20230508002429747](./10%EA%B0%95.assets/image-20230508002429747.png)

-첫번째 단계 카프카는 라우팅 용도로 모든 데이터를 수집

 - Router(자체 스트림 프로세싱, 라우팅 애플리케이션)을 사용하여 두번째 카프카 또는 하둡, 엘라스틱서 치와 같은 데이터베이스로 전달

=> 많은 데이터는 batch로 S3사용가능, 실시간 낮은 지연으로 분석필요하면 Elastic Search가능

=> Custom 분석은 플링크 같은거 사용가능

### 라인 쇼핑 플랫폼 사례

![image-20230508002902997](./10%EA%B0%95.assets/image-20230508002902997.png)

-시스템 유연성을 개선하고 처리량에 한계를 없애기 위해 카프카를 중앙에 둔 아키텍처 적용

 -카프카 커넥트 도입. mongodb CDC(Change Data Capture) 커넥터 활용

-이벤트 기반 데이터 처리로 상품 처리가 매우 빨라짐

###  11번가, 주문/결제 시스템 적용 상례

![image-20230508003057580](./10%EA%B0%95.assets/image-20230508003057580.png)

\- 데이터 베이스의 병목현상을 해소하기 위해 도입 

-카프카를 단일 진실 공급원(Source of Truth)으로 정의

-메시지를 Materalized View로 구축하여 배치 데이터처럼 활용



## 카프카 기술 별 아키텍처 적용 방법 정리

##### 카프카 커넥트

-반복적인 파이프라인을 만들어야할 경우 분산 모드 커넥트를 설치하고 운영 

-되도록 오픈소스 커넥터를 사용하되, 필요시 커스텀 커넥터 개발하여 운영 

-rest api와 통신하여 동작할 수 있는 웹 화면을 개발하거나 오픈소스 활용하는 것을 추천 

##### 카프카 스트림즈

-강력한 stateful, stateless 프로세싱 기능이 들어 있으므로 카프카의 토픽의 데이터 처리시 선택

##### 카프카 컨슈머, 프로듀서

-커넥트와 스트림즈로 구현할 수 없거나 단일성 파이프라인, 개발일 경우에는 컨슈머 또는 프로듀서로 개발



![image-20230508004108774](./10%EA%B0%95.assets/image-20230508004108774.png)

-프로듀서를 통해 데이터 최초로 유입 

-토픽 기반 데이터 프로세싱은 카프카 스트림즈로 처리 

-반복된 파이프라인은 카프카 커넥트에서 운영. 단발적인 처리는 컨슈머로 개발